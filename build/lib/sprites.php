<?php

// 
function build_sprites() {
  $feedback = "<h3>Building sprites...</h3>\n";
  
  $R = array();
  $R['spriteTextures'] = array();
  $R['spriteCharacters'] = array();
  $R['spriteSlices'] = array();
  $R['spriteSlicesByOriginalFilename'] = array();
  
  $DATA = json_decode(file_get_contents('sprites/data.json'), true);
  foreach ($DATA['textures'] as $textureName => $texture) {
    $feedback .= "$textureName<br/>\n";
    
    $textureFile = "$textureName.png";
    
    $SLICES = json_decode(file_get_contents("sprites/textures/$textureName.json"), true);
    copy("sprites/textures/$textureName.png",         "res/$textureName.png");
    copy("sprites/textures/$textureName-x.png",       "res/$textureName-x.png");
    copy("sprites/textures/$textureName-pink.png",    "res/$textureName-pink.png");
    copy("sprites/textures/$textureName-pink-x.png",  "res/$textureName-pink-x.png");
    copy("sprites/textures/$textureName-cyan.png",    "res/$textureName-cyan.png");
    copy("sprites/textures/$textureName-cyan-x.png",  "res/$textureName-cyan-x.png");
    copy("sprites/textures/$textureName-wacky.png",   "res/$textureName-wacky.png");
    copy("sprites/textures/$textureName-wacky-x.png", "res/$textureName-wacky-x.png");
    $R['spriteTextures'][$textureFile] = array(
      'imageModifiers' => array( 1, 2, 4 ), // XXX
    );
    
    foreach ($SLICES as $filename => $slice) {
      $R['spriteSlicesByOriginalFilename'][$filename] = array($slice[0], $slice[1], $slice[2], $slice[3], $textureFile);
    }
    
    $R['spriteSlices'][$textureFile] = array_values($SLICES);
    $SLICES = array_combine(array_keys($SLICES), range(0, count($SLICES)-1)); // map slice filenames to indicies in $R['spriteSlices'][$textureName]
    
    foreach ($texture['characters'] as $characterName => $character) {
      $animations = array();
      foreach ($character['animations'] as $animationName => $animation) {
        $frames = array();
        foreach ($animation['frames'] as $frame) {
          $frame['slice'] = $SLICES[$frame['slice']];
          $frames[] = $frame;
        }
        $animations[$animationName] = array(
          'loop'   => $animation['loop'],
          'frames' => $frames,
        );
      }
      if (@$R['spriteCharacters'][$characterName]) { die("Resource sprites/data.json - character name conflict: $characterName"); }
      $R['spriteCharacters'][$characterName] = array(
        'image'     => $textureFile,
        'sequences' => $animations,
      );
    }
  }
  
  file_put_contents('src/R.sprites.js', "// DO NOT EDIT THIS FILE: it is automatically generated by build/lib/sprites.php\n\n_.extend(R, \n" . json_encode($R) . "\n);\n");
  
  return $feedback;
}

?>
